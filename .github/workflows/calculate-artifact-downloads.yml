name: Calculate Artifact Downloads

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["build.yml"]
    types:
      - completed

jobs:
  calculate-downloads:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get Artifacts
        id: artifacts
        run: |
          artifacts=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts" | jq '.artifacts')
          total_downloads=$(echo "$artifacts" | jq '[.[] | .download_count] | add')
          echo "Total downloads: $total_downloads"
          echo "total_downloads=$total_downloads" >> $GITHUB_ENV

      - name: Update Downloads JSON
        run: |
          echo '{
            "schemaVersion": 1,
            "label": "downloads",
            "message": "'$total_downloads'",
            "color": "blue"
          }' > downloads.json

      - name: Debug Downloads JSON
        run: |
          cat downloads.json

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add downloads.json
          git commit -m "Update downloads count"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
